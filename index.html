<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RouteLink â€” Web App (with Messages)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    :root{
      --accent:#0b5878;
      --accent-2:#e85a4f;
      --muted:#6c7a89;
      --card:#ffffff;
      --bg:#f3fbff;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;margin:0;padding:0}
    .banner { background: linear-gradient(90deg, rgba(11,88,120,0.06), rgba(232,90,79,0.02)); padding: 22px; border-radius: 8px; display:flex; gap:18px; align-items:center; margin-bottom:18px; }
    .banner img{ width:120px; height:120px; object-fit:cover; border-radius:12px; box-shadow:0 6px 18px rgba(11,88,120,0.06); }
    .banner h1{ margin:0; font-size:28px; color:var(--accent); font-weight:800; }
    .banner p.lead{ margin:6px 0 0 0; color:var(--accent-2); font-weight:700; font-size:20px; }
    .banner p.sub{ margin:8px 0 0 0; color:var(--muted); font-style:italic; }
    .topbar{padding:14px 18px;background:linear-gradient(90deg,#f6fbfd,#eef9fb);border-radius:12px;margin-bottom:18px;display:flex;align-items:center;gap:12px}
    .logobox{width:72px;height:72px;border-radius:12px;background:linear-gradient(180deg,#fff,#f0fbff);display:flex;align-items:center;justify-content:center}
    .brand{color:var(--accent);font-weight:800;font-size:22px}
    .tagline{color:var(--muted);font-style:italic}
    .section-card{background:var(--card);border-radius:12px;padding:18px;margin-bottom:16px;box-shadow:0 6px 18px rgba(13,40,50,0.04)}
    .mini-cal{display:flex;flex-wrap:wrap;gap:6px}
    .cal-day{width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid #e6eef1;user-select:none}
    .cal-day:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(11,88,120,0.06)}
    .cal-today{background:var(--accent);color:#fff;font-weight:700}
    .cal-weekend{background:linear-gradient(180deg,#fff8e6,#fff5e0); color:#7b5200; border:1px solid #ffe7b5}
    .cal-festival{background:linear-gradient(180deg,#fff0f0,#fff8f8); color:#b33; border:1px solid #ffdede}
    .slot-pill{background:#ecfbf9;color:#0a6b5b;padding:6px 10px;border-radius:999px;font-weight:700}
    .transport-pill{background:#eef6ff;color:#0b5878;padding:4px 8px;border-radius:8px;font-weight:600;border:1px solid #d6eaf6}
    .muted-small{color:var(--muted);font-size:0.95rem}
    .hidden{display:none!important}
    .nav-locked .nav-link{opacity:0.45;pointer-events:none}
    .feature-card { border-radius:12px; padding:12px; background: linear-gradient(180deg,#ffffff,#fbfeff); box-shadow:0 4px 12px rgba(11,88,120,0.03) }
    .btn-delete { background: transparent; border: 1px solid #f8d7da; color: #c82333; }
    .small-muted { color:#9aa6ad; font-size:0.95rem; }
    .legend { display:flex; gap:12px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .legend .item { display:flex; gap:6px; align-items:center; font-size:0.92rem; color:var(--muted); }
    .legend .sw { width:18px; height:18px; border-radius:4px; display:inline-block }
    .sw-weekend { background: linear-gradient(180deg,#fff8e6,#fff5e0); border:1px solid #ffe7b5 }
    .sw-fest { background: linear-gradient(180deg,#fff0f0,#fff8f8); border:1px solid #ffdede }
    .sw-today { background: var(--accent); border-radius:4px; }
    /* DM column-specific style */
    .dm-header { font-family: "Courier New", Courier, monospace; letter-spacing:1px; font-weight:700; color:var(--accent-2); }
    .dm-btn { font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial; font-weight:700; font-size:0.9rem; padding:4px 8px; border-radius:6px; }
    /* Messages layout */
    .messages-panel { display:flex; gap:12px; height:520px; }
    .convos-list { width:320px; background:#fff; border-radius:10px; padding:8px; box-shadow:0 6px 18px rgba(11,88,120,0.04); overflow:auto; }
    .chat-window { flex:1; background:#fff; border-radius:10px; padding:12px; box-shadow:0 6px 18px rgba(11,88,120,0.04); display:flex; flex-direction:column; }
    .convo-item { display:flex; gap:10px; align-items:center; padding:8px; border-radius:8px; cursor:pointer; }
    .convo-item:hover { background:#f6fbff; }
    .avatar { width:42px; height:42px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:18px; }
    .msg-list { flex:1; overflow:auto; padding:8px; display:flex; flex-direction:column; gap:8px; }
    .msg-row { display:flex; gap:8px; align-items:flex-end; max-width:75%; }
    .msg-row.me { margin-left:auto; flex-direction:row-reverse; }
    .msg-bubble { padding:8px 10px; border-radius:12px; background:#f1f7fa; box-shadow:0 2px 6px rgba(0,0,0,0.03); }
    .msg-bubble.me { background:linear-gradient(180deg,#e6f7ff,#dceff6); }
    .messages-input { display:flex; gap:8px; margin-top:8px; }
    /* Group chat button style and placement */
    .group-chat-anchor { position:absolute; right:16px; bottom:16px; z-index:20; }
    .group-chat-btn { font-weight:800; color:#fff; background:#0b5cff; border:1px solid #084bd6; box-shadow: 0 6px 18px rgba(11,88,255,0.12); }
    .group-chat-btn:hover { background:#084bd6; border-color:#0639b0; }
    @media (max-width:1000px){ .messages-panel { flex-direction:column; height:auto } .convos-list{ width:100%; } .group-chat-anchor{ position:static; margin-top:12px; float:none; } }
  </style>
</head>
<body>
  <div class="container py-4">

    <!-- Banner -->
    <div class="banner">
      <img src="/static/banner.jpg" alt="banner" onerror="this.src='/static/logo.png'"/>
      <div>
        <h1><i class="bi bi-people-fill" style="color:var(--accent)"></i> RouteLink</h1>
        <p class="lead">A student-first travel connection platform for VIT students</p>
        <p class="sub">Plan, match, and share journeys â€” smartly, safely, and together.</p>
      </div>
    </div>

    <!-- Topbar -->
    <div class="topbar">
      <div class="d-flex align-items-center gap-3">
        <div class="logobox">
          <img src="/static/logo.png" alt="logo" width="52" height="52" onerror="this.src='https://img.icons8.com/fluency/48/bus.png'"/>
        </div>
        <div>
          <div class="brand">RouteLink Web</div>
          <div class="tagline">Every Link Counts, Every Route Matters</div>
        </div>
      </div>

      <div class="ms-auto d-flex align-items-center gap-2" id="authArea">
        <input id="top_email" class="form-control form-control-sm" placeholder="email@vitstudent.ac.in" style="width:220px"/>
        <input id="top_pw" type="password" class="form-control form-control-sm" placeholder="Password" style="width:170px"/>
        <button id="btnTopLogin" class="btn btn-sm btn-primary">Login</button>
        <button id="btnOpenRegister" class="btn btn-sm btn-outline-primary">Register</button>
      </div>

      <!-- Logout always visible -->
      <div class="ms-3">
        <button id="btnLogout" class="btn btn-sm btn-outline-danger">Logout</button>
      </div>

      <div id="loggedBlock" class="d-flex align-items-center gap-2 hidden ms-3">
        <div class="muted-small">Welcome, <strong id="userName"></strong></div>
      </div>
    </div>

    <!-- Nav (added Messages tab) -->
    <ul class="nav nav-tabs mb-3 nav-locked" id="mainTabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" id="tabBtnHome" data-bs-toggle="tab" data-bs-target="#tab-home">Home</button></li>
      <li class="nav-item"><button class="nav-link disabled" id="tabBtnCalendar" data-bs-toggle="tab" data-bs-target="#tab-calendar">Calendar</button></li>
      <li class="nav-item"><button class="nav-link disabled" id="tabBtnRoutes" data-bs-toggle="tab" data-bs-target="#tab-routes">Route Details</button></li>
      <li class="nav-item"><button class="nav-link disabled" id="tabBtnLinks" data-bs-toggle="tab" data-bs-target="#tab-links">Link Details</button></li>
      <li class="nav-item"><button class="nav-link disabled" id="tabBtnMessages" data-bs-toggle="tab" data-bs-target="#tab-messages">Messages</button></li>
    </ul>

    <div class="tab-content">
      <!-- HOME -->
      <div class="tab-pane fade show active section-card" id="tab-home">
        <div class="row">
          <div class="col-lg-6">
            <h4><i class="bi bi-box-arrow-in-right"></i> Login</h4>
            <p class="small-muted">Sign in with your VIT student email to access scheduling features.</p>
            <div class="mb-2"><input id="login_email" class="form-control" placeholder="email@vitstudent.ac.in"></div>
            <div class="mb-2"><input id="login_pw" type="password" class="form-control" placeholder="Password"></div>
            <div class="d-flex gap-2">
              <button id="doLogin" class="btn btn-primary">Login</button>
              <button id="clearLogin" class="btn btn-outline-secondary">Clear</button>
            </div>
            <div class="mt-2 text-danger small" id="loginMsg"></div>
          </div>

          <div class="col-lg-6">
            <h4><i class="bi bi-person-plus-fill"></i> Register</h4>
            <p class="small-muted">Create an account using your VIT student email.</p>
            <div class="mb-2"><input id="reg_name" class="form-control" placeholder="Full name"></div>
            <div class="mb-2"><input id="reg_email" class="form-control" placeholder="email@vitstudent.ac.in"></div>
            <div class="mb-2"><input id="reg_pw" type="password" class="form-control" placeholder="Password"></div>
            <div class="mb-2 d-flex gap-2 align-items-center">
              <select id="reg_gender" class="form-select" style="width:120px"><option value="M">Male</option><option value="F">Female</option></select>
              <button id="doRegister" class="btn btn-outline-primary">Register</button>
            </div>
            <div class="mt-2 text-danger small" id="regMsg"></div>
          </div>
        </div>
      </div>

      <!-- CALENDAR -->
      <div class="tab-pane fade section-card hidden" id="tab-calendar">
        <div class="row">
          <div class="col-md-4">
            <h5><i class="bi bi-calendar4-week"></i> Calendar</h5>
            <p class="small-muted">Hover dates to preview routes. Click a date to view Route Details. Past dates cannot be scheduled.</p>

            <div id="miniCalendar" class="mini-cal mb-3"></div>

            <div class="legend">
              <div class="item"><span class="sw sw-weekend"></span> <span class="muted-small">Weekend</span></div>
              <div class="item"><span class="sw sw-fest"></span> <span class="muted-small">Festival / Holiday</span></div>
              <div class="item"><span class="sw sw-today"></span> <span class="muted-small">Today</span></div>
            </div>

            <div class="mt-3">
              <h6 class="mb-2">Holidays</h6>
              <ul id="holList" class="small-muted"></ul>
            </div>
          </div>

          <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center">
              <h5><i class="bi bi-truck"></i> Routes on <span id="routesDateLabel"></span></h5>
              <div class="small-muted">Select a route in Route Details to view candidates.</div>
            </div>
            <div id="routesContainer" class="mt-3"></div>
          </div>
        </div>
      </div>

      <!-- ROUTE DETAILS (Add Route button moved here) -->
      <div class="tab-pane fade section-card hidden" id="tab-routes">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5><i class="bi bi-signpost-2-fill"></i> Route Details â€” <span id="routeTabDate"></span></h5>
          <div>
            <button id="btnAddRoute" class="btn btn-success me-2">âž• Add Route</button>
            <button id="btnRefreshRoutes" class="btn btn-outline-secondary">Refresh</button>
          </div>
        </div>
        <div id="routesTable"></div>
      </div>

      <!-- LINK DETAILS -->
      <div class="tab-pane fade section-card hidden" id="tab-links" style="position:relative;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5><i class="bi bi-people-fill"></i> Link Details for <span id="linksRouteLabel"></span></h5>
          <div class="d-flex align-items-center gap-2">
            <label class="me-2 small">Gender</label>
            <select id="linksGender" class="form-select form-select-sm" style="width:120px"><option>All</option><option>Male</option><option>Female</option></select>
            <button id="btnFilterLinks" class="btn btn-sm btn-outline-secondary">Filter</button>
            <button id="btnOpenJoin" class="btn btn-sm btn-primary">Join this route</button>
            <button id="btnRefreshLinks" class="btn btn-sm btn-outline-secondary">Refresh</button>
          </div>
        </div>

        <div id="linksArea" style="position:relative; padding-bottom:72px;">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Name</th><th>Gender</th><th>Drop</th><th>Phone</th><th>Year</th><th>Branch</th>
                <th class="dm-header">DM</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="linksTbody"></tbody>
          </table>

          <!-- Group Chat button for the currently selected route (bottom-right of Link Details area) -->
          <div class="group-chat-anchor">
            <button id="btnGroupChatLinks" class="btn group-chat-btn">Group Chat for this route</button>
          </div>
        </div>
      </div>

      <!-- MESSAGES tab -->
      <div class="tab-pane fade section-card hidden" id="tab-messages">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5><i class="bi bi-chat-dots-fill"></i> Messages</h5>
          <div class="small-muted">Direct Messages & Group Chats</div>
        </div>

        <div class="messages-panel">
          <div class="convos-list" id="convosList">
            <div class="mb-2"><strong>Your conversations</strong></div>
            <div id="convosInner"></div>
          </div>

          <div class="chat-window" id="chatWindow" aria-live="polite">
            <div id="activeConvoHeader" class="d-flex align-items-center gap-3 mb-2">
              <div class="avatar" id="activeConvoAvatar">ðŸ’¬</div>
              <div>
                <div id="activeConvoName"><strong>No conversation selected</strong></div>
                <div id="activeConvoSub" class="small-muted">Select a DM or group to start chatting.</div>
              </div>
            </div>

            <div class="msg-list" id="msgList">
              <div class="small-muted">No messages yet. Select a conversation or start a DM from Link Details.</div>
            </div>

            <div class="messages-input">
              <input id="msgText" class="form-control" placeholder="Type a message..." />
              <button id="btnSendMsg" class="btn btn-primary">Send</button>
            </div>
          </div>
        </div>
      </div>

    </div> <!-- tab-content end -->

    <!-- Add Route Modal -->
    <div class="modal fade" id="modalAddRoute" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Route â€” <small id="modalRouteDate"></small></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <table class="table table-borderless">
              <tbody>
                <tr><td style="width:160px"><label>Slot No</label></td><td><input id="modal_slot" class="form-control" readonly></td></tr>
                <tr><td><label>End Point</label></td><td><input id="modal_endpoint" class="form-control" placeholder="Main Gate"></td></tr>
                <tr><td><label>Major Stops</label></td><td><input id="modal_stops" class="form-control" placeholder="Comma separated"></td></tr>
                <tr><td><label>Time (HH:MM)</label></td><td><input id="modal_time" class="form-control" placeholder="09:30"></td></tr>
                <tr><td><label>Transport</label></td><td><select id="modal_transport" class="form-select" style="width:160px"><option value="">(select)</option><option value="bus">Bus</option><option value="car">Car</option></select></td></tr>
              </tbody>
            </table>
            <div id="modalAddRouteMsg" class="text-danger small"></div>
          </div>
          <div class="modal-footer">
            <button id="modalAddRouteCancel" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button id="modalAddRouteSubmit" class="btn btn-success">Create Route</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Candidates Modal -->
    <div class="modal fade" id="modalCandidates" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Candidates for <span id="candRouteLabel"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="candidatesList" class="list-group"></div>
            <div id="candidatesMsg" class="text-muted small mt-2"></div>
          </div>
          <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
        </div>
      </div>
    </div>

    <!-- Join Offcanvas -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasJoin" aria-labelledby="offcanvasJoinLabel">
      <div class="offcanvas-header">
        <h5 id="offcanvasJoinLabel">Join Route â€” <small id="offcanvasJoinDate"></small></h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <div id="offJoinRouteInfo" class="mb-2"></div>
        <div class="mb-2"><label class="form-label small">Name</label><input id="join_name" class="form-control" readonly></div>
        <div class="mb-2"><label class="form-label small">Gender</label><select id="join_gender" class="form-select"><option value="M">M</option><option value="F">F</option></select></div>
        <div class="mb-2"><label class="form-label small">Phone</label><input id="join_phone" class="form-control" placeholder="Phone"></div>
        <div class="mb-2"><label class="form-label small">Year</label><input id="join_year" class="form-control" placeholder="Year"></div>
        <div class="mb-2"><label class="form-label small">Branch</label><input id="join_branch" class="form-control" placeholder="Branch"></div>
        <div class="mb-2"><label class="form-label small">Drop point</label><input id="join_drop" class="form-control" readonly></div>
        <div class="mt-2"><button id="btnDoJoinOff" class="btn btn-primary">Join</button> <span id="joinOffMsg" class="text-danger ms-2"></span></div>
      </div>
    </div>

  </div> <!-- container -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // --- Utilities & state
  const el = id => document.getElementById(id);
  function localIso(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
  function todayLocalIso(){ const n=new Date(); return localIso(n.getFullYear(), n.getMonth()+1, n.getDate()); }

  // app state
  let loggedUser = null;            // { id?, name, email }
  let currentSelectedDate = todayLocalIso();
  let lastCandidatesRouteId = null; // selected route id via candidates
  let viewingRouteId = null;        // route currently being viewed in links

  // messaging state
  let activeConversation = null; // { type: 'dm'|'group', id, name }
  let conversationsCache = []; // list of { type, id, name, last_message, avatar_emoji }
  let convoPollTimer = null;

  function fetchWithCreds(url, opts={}){ opts.credentials = opts.credentials || 'same-origin'; return fetch(url, opts); }

  function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m])); }

  // --- Tab helpers
  function disableAllTabsExceptHome(){
    el('tabBtnCalendar').classList.add('disabled');
    el('tabBtnRoutes').classList.add('disabled');
    el('tabBtnLinks').classList.add('disabled');
    el('tabBtnMessages').classList.add('disabled');
    document.querySelector('#mainTabs').classList.add('nav-locked');
    document.querySelectorAll('.tab-pane').forEach(p => { if (p.id !== 'tab-home') p.classList.add('hidden'); });
  }
  function enableCalendarOnly(){
    el('tabBtnCalendar').classList.remove('disabled');
    document.querySelector('#mainTabs').classList.remove('nav-locked');
    el('tab-calendar').classList.remove('hidden');
    el('tab-routes').classList.remove('hidden');
    el('tab-links').classList.remove('hidden');
    el('tab-messages').classList.remove('hidden');
    el('tabBtnRoutes').classList.add('disabled');
    el('tabBtnLinks').classList.add('disabled');
  }
  function enableRoutes(){ el('tabBtnRoutes').classList.remove('disabled'); }
  function enableLinks(){ el('tabBtnLinks').classList.remove('disabled'); }
  function enableMessages(){ el('tabBtnMessages').classList.remove('disabled'); }

  // --- DOM wiring
  document.addEventListener('DOMContentLoaded', ()=>{
    disableAllTabsExceptHome();
    new bootstrap.Tab(el('tabBtnHome')).show();
    if (el('routesDateLabel')) el('routesDateLabel').textContent = currentSelectedDate;

    // Logout
    el('btnLogout')?.addEventListener('click', async ()=>{
      try { await fetchWithCreds('/logout', { method:'POST' }); } catch(e){ console.warn(e); }
      loggedUser = null;
      el('authArea').classList.remove('hidden');
      el('loggedBlock')?.classList.add('hidden');
      if (el('top_email')) el('top_email').value=''; if (el('top_pw')) el('top_pw').value='';
      disableAllTabsExceptHome();
      new bootstrap.Tab(el('tabBtnHome')).show();
    });

    // Login
    async function handleLogin(){
      el('loginMsg').textContent = '';
      const email = (el('login_email')?.value || el('top_email')?.value || '').trim();
      const pw = (el('login_pw')?.value || el('top_pw')?.value || '');
      if (!email || !pw){ el('loginMsg').textContent = 'Email and password required'; return; }
      try {
        const res = await fetchWithCreds('/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password: pw }) });
        const body = await (res.json().catch(()=>({})));
        if (res.ok){
          // backend should return { name, id? }
          loggedUser = { id: body.id || null, name: body.name || '', email };
          el('userName').textContent = loggedUser.name || loggedUser.email || '';
          el('authArea').classList.add('hidden');
          el('loggedBlock')?.classList.remove('hidden');
          enableCalendarOnly();
          enableMessages();
          new bootstrap.Tab(el('tabBtnCalendar')).show();
          await loadHolidays();
          buildMiniCalendar();
          loadRoutesForDate(currentSelectedDate);
          await loadConversationsList();
        } else {
          el('loginMsg').textContent = (body && body.error) ? body.error : `Login failed (${res.status})`;
        }
      } catch (e){
        console.error('login', e);
        el('loginMsg').textContent = 'Network error â€” check server';
      }
    }
    el('doLogin')?.addEventListener('click', handleLogin);
    el('btnTopLogin')?.addEventListener('click', handleLogin);

    // Register
    el('doRegister')?.addEventListener('click', async ()=>{
      el('regMsg').textContent = '';
      const name = el('reg_name')?.value.trim() || '', email = el('reg_email')?.value.trim() || '', pw = el('reg_pw')?.value || '', gender = el('reg_gender')?.value || 'M';
      if (!name || !email || !pw){ el('regMsg').textContent = 'All fields required'; return; }
      try {
        const r = await fetchWithCreds('/register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, email, password: pw, gender }) });
        const body = await (r.json().catch(()=>({})));
        if (r.ok){ el('regMsg').style.color='green'; el('regMsg').textContent='Registered â€” please login'; }
        else { el('regMsg').style.color='red'; el('regMsg').textContent = body.error || `Register failed (${r.status})`; }
      } catch (e){ console.error('register', e); el('regMsg').textContent = 'Network error'; }
    });

    // Clear login inputs
    el('clearLogin')?.addEventListener('click', ()=> {
      if (el('login_email')) el('login_email').value=''; if (el('login_pw')) el('login_pw').value=''; if (el('top_email')) el('top_email').value=''; if (el('top_pw')) el('top_pw').value='';
      el('loginMsg').textContent = '';
    });

    // Add route modal wiring
    const modalAddRoute = new bootstrap.Modal(document.getElementById('modalAddRoute'));
    el('btnAddRoute')?.addEventListener('click', async ()=>{
      if (el('tabBtnRoutes').classList.contains('disabled') && el('tabBtnCalendar').classList.contains('disabled')) { alert('Login required'); return; }
      el('modalRouteDate').textContent = currentSelectedDate;
      el('modalAddRouteMsg').textContent = '';
      try { const r = await fetchWithCreds('/next_slot'); const j = await r.json(); el('modal_slot').value = j.slot || 'SL0000'; } catch(e){ el('modal_slot').value = 'SL0000'; }
      el('modal_endpoint').value=''; el('modal_stops').value=''; el('modal_time').value=''; el('modal_transport').value='';
      modalAddRoute.show();
    });

    el('modalAddRouteSubmit')?.addEventListener('click', async ()=>{
      const date = currentSelectedDate;
      const slot = el('modal_slot').value.trim();
      const endp = el('modal_endpoint').value.trim();
      const stops = el('modal_stops').value.trim();
      const time = el('modal_time').value.trim();
      const transport = el('modal_transport').value.trim();
      if (!date || !slot || !endp){ el('modalAddRouteMsg').textContent = 'Date, Slot and End Point are required'; return; }
      if (time && !/^\d{2}:\d{2}$/.test(time)){ el('modalAddRouteMsg').textContent = 'Time must be HH:MM'; return; }
      try {
        const r = await fetchWithCreds('/routes', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ date, slot_no:slot, end_point:endp, major_stops:stops, time, transport_type:transport }) });
        if (r.status === 201) { modalAddRoute.hide(); await loadRoutesForDate(date); }
        else { const txt = await r.text(); el('modalAddRouteMsg').textContent = txt || `Error (${r.status})`; }
      } catch (e){ console.error('add route', e); el('modalAddRouteMsg').textContent = 'Network error'; }
    });

    // Join offcanvas open
    el('btnOpenJoin')?.addEventListener('click', async ()=>{
      const rid = lastCandidatesRouteId || viewingRouteId;
      if (!rid){ alert('Open a route from Route Details first (double-click its row) to join'); return; }
      el('offcanvasJoinDate').textContent = currentSelectedDate;
      try {
        const r = await fetchWithCreds('/calendar/' + currentSelectedDate);
        const rows = await r.json();
        const route = rows.find(x=>x.id === rid);
        el('offJoinRouteInfo').innerHTML = route ? `<div><strong>${route.slot_no} â†’ ${route.end_point}</strong></div><div class="small-muted">${route.major_stops || ''}</div>` : '';
        el('join_drop').value = route ? (route.end_point || '') : '';
      } catch(e){ el('offJoinRouteInfo').innerHTML = ''; }
      if (loggedUser && el('join_name')){ el('join_name').value = loggedUser.name || ''; el('join_name').readOnly = true; }
      const oc = new bootstrap.Offcanvas(document.getElementById('offcanvasJoin')); oc.show();
    });

    el('btnDoJoinOff')?.addEventListener('click', async ()=>{
      const rid = lastCandidatesRouteId || viewingRouteId;
      if (!rid){ el('joinOffMsg').textContent = 'No route selected'; return; }
      const payload = {
        date: currentSelectedDate,
        name: el('join_name')?.value || '',
        gender: el('join_gender')?.value || 'M',
        drop: el('join_drop')?.value || '',
        phone: el('join_phone')?.value || '',
        course_year: el('join_year')?.value || '',
        branch: el('join_branch')?.value || ''
      };
      el('joinOffMsg').textContent = '';
      try {
        const r = await fetchWithCreds(`/routes/${rid}/join`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if (r.status === 201){
          el('joinOffMsg').style.color='green'; el('joinOffMsg').textContent = 'Joined';
          await loadLinksForCurrentRoute(el('linksGender')?.value || 'All');
          await loadRoutesForDate(currentSelectedDate);
        } else {
          const txt = await r.text(); el('joinOffMsg').style.color='red'; el('joinOffMsg').textContent = txt;
        }
      } catch(e){ console.error('join', e); el('joinOffMsg').style.color='red'; el('joinOffMsg').textContent = 'Network error'; }
    });

    // refresh & filters
    el('btnRefreshRoutes')?.addEventListener('click', ()=> loadRoutesForDate(currentSelectedDate));
    el('btnRefreshLinks')?.addEventListener('click', ()=> loadLinksForCurrentRoute(el('linksGender')?.value || 'All'));
    el('btnFilterLinks')?.addEventListener('click', ()=> loadLinksForCurrentRoute(el('linksGender')?.value || 'All'));
    el('linksGender')?.addEventListener('change', ()=> loadLinksForCurrentRoute(el('linksGender')?.value || 'All'));

    // DM send
    el('btnSendMsg')?.addEventListener('click', sendMessageFromInput);
    el('msgText')?.addEventListener('keydown', (ev)=> { if (ev.key === 'Enter') sendMessageFromInput(); });

    // Group Chat button in Link Details tab (bottom-right)
    el('btnGroupChatLinks')?.addEventListener('click', async ()=>{
      const rid = lastCandidatesRouteId || viewingRouteId;
      if (!rid){ alert('Open a route first (double-click a route row in Route Details) to create or open its group chat.'); return; }
      try {
        // create/get group for route
        const res = await fetchWithCreds(`/groups/route/${encodeURIComponent(rid)}`, { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ date: currentSelectedDate }) });
        if (!res.ok){
          console.error('group create failed', res.status, await res.text().catch(()=>'')); 
          alert('Unable to create or open group chat. Please check server.');
          return;
        }
        const j = await res.json();
        // j expected: { group_id, name }
        openConversation(j.group_id, j.name || `Route ${rid} Group`, 'group');
      } catch(e){ console.error('group', e); alert('Network error while creating group'); }
    });

    // initial conversations load
    loadConversationsList();
  }); // DOMContentLoaded end

  // --- Holidays and calendar (same as earlier)
  async function loadHolidays(){
    try {
      const r = await fetchWithCreds('/holidays');
      window.__hols = await r.json();
      const ul = el('holList'); if (ul){ ul.innerHTML=''; (window.__hols||[]).forEach(h=>{ const li=document.createElement('li'); li.textContent = `${new Date(h).toLocaleDateString()} â€” ${h}`; ul.appendChild(li); }); }
    } catch(e){ window.__hols = []; }
  }
  function isPast(iso){ return new Date(iso) < new Date(todayLocalIso()); }

  async function buildMiniCalendar(monthOffset=0){
    const base = new Date(); base.setMonth(base.getMonth() + monthOffset);
    const year = base.getFullYear(), month = base.getMonth();
    const first = new Date(year, month, 1);
    const days = new Date(year, month+1, 0).getDate();
    const startWeekday = (first.getDay() + 6) % 7; // Mon=0
    const container = el('miniCalendar'); if (!container) return; container.innerHTML = '';
    const hdr = document.createElement('div'); hdr.className = 'd-flex justify-content-between align-items-center mb-2';
    hdr.innerHTML = `<div><strong>${first.toLocaleString(undefined,{month:'long', year:'numeric'})}</strong></div><div><button id="prevM" class="btn btn-sm btn-outline-secondary me-1">&lt;</button><button id="nextM" class="btn btn-sm btn-outline-secondary">&gt;</button></div>`;
    container.appendChild(hdr);
    const wd = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']; const wdrow=document.createElement('div'); wdrow.className='d-flex gap-1 mb-2';
    wd.forEach(d=>{ const s=document.createElement('div'); s.style.width='44px'; s.style.textAlign='center'; s.style.color='#7b8a93'; s.textContent=d; wdrow.appendChild(s); });
    container.appendChild(wdrow);
    const grid = document.createElement('div'); grid.className='d-flex flex-wrap gap-2';
    for(let i=0;i<startWeekday;i++){ const blank=document.createElement('div'); blank.style.width='44px'; blank.style.height='44px'; grid.appendChild(blank); }
    for(let day=1; day<=days; day++){
      const iso = localIso(year, month+1, day);
      const dEl = document.createElement('div'); dEl.className='cal-day'; dEl.textContent = day;
      const dt = new Date(year, month, day);
      const wk = dt.getDay(); // 0 Sun .. 6 Sat
      if (wk === 0 || wk === 6) dEl.classList.add('cal-weekend');
      if ((window.__hols||[]).includes(iso)) dEl.classList.add('cal-festival');
      if (iso === todayLocalIso()) dEl.classList.add('cal-today');

      dEl.onmouseenter = async () => {
        let summ = '';
        try { const r = await fetchWithCreds('/calendar/' + iso); const js = await r.json(); if (js && js.length) summ = js.map((s,i)=> `${i+1}) ${s.slot_no} â†’ ${s.end_point || '-'} @ ${s.time || '-'}`).join('\n'); else if ((window.__hols||[]).includes(iso)) summ = 'Holiday'; else if (isPast(iso)) summ = 'Past â€” cannot schedule'; else summ = 'No routes â€” click'; } catch(e){ summ='Unable to load'; }
        dEl.title = summ;
      };
      dEl.onclick = () => {
        if (isPast(iso)){ alert('This date has passed. Scheduling disabled.'); return; }
        currentSelectedDate = iso;
        if (el('routesDateLabel')) el('routesDateLabel').textContent = iso;
        enableRoutes();
        new bootstrap.Tab(el('tabBtnRoutes')).show();
        loadRoutesForDate(iso);
      };
      grid.appendChild(dEl);
    }
    container.appendChild(grid);
    el('prevM').onclick = ()=> buildMiniCalendar(monthOffset-1);
    el('nextM').onclick = ()=> buildMiniCalendar(monthOffset+1);
  }

  // --- Routes & Links (mostly same) ---
  async function loadRoutesForDate(iso){
    if (el('routesDateLabel')) el('routesDateLabel').textContent = iso;
    if (el('routeTabDate')) el('routeTabDate').textContent = iso;
    try {
      const res = await fetchWithCreds('/calendar/' + iso);
      const js = await res.json();
      const container = el('routesContainer'); if (!container) return; container.innerHTML = '';
      if (!js || js.length === 0) container.innerHTML = '<div class="muted-small">No routes yet. Use "Add Route" to create one.</div>';
      else {
        for (const route of js){
          let count = 0;
          try {
            const r = await fetchWithCreds(`/route_count?date=${encodeURIComponent(iso)}&route_id=${route.id}`);
            const j = await r.json(); count = j.count || 0;
          } catch(e){ count = 0; }

          const card = document.createElement('div'); card.className = 'd-flex justify-content-between align-items-center p-3 mb-2 border rounded';
          const left = document.createElement('div');
          const transportLabel = route.transport_type ? `<div class="mt-1"><span class="transport-pill">${route.transport_type}</span></div>` : '';
          left.innerHTML = `<div><span class="slot-pill">${route.slot_no}</span> <strong class="ms-2">${route.end_point || ''}</strong></div><div class="muted-small">${route.major_stops || ''}</div>${transportLabel}`;
          const right = document.createElement('div');
          right.innerHTML = `<div>${route.time || '-'}</div>
                             <div class="mt-2"><span class="badge bg-info">Counter: ${count}</span>
                             <button class="btn btn-sm btn-primary ms-2" onclick="openRoutePanel(${route.id})">View</button></div>`;
          card.appendChild(left); card.appendChild(right);
          container.appendChild(card);
        }
      }
      await buildRouteTable(js, iso);
    } catch(e){ console.error('loadRoutesForDate', e); }
  }

  async function buildRouteTable(routes, iso){
    const wrapper = el('routesTable'); if (!wrapper) return; wrapper.innerHTML = '';
    const table = document.createElement('table'); table.className = 'table table-hover';
    const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Slot</th><th>End Point</th><th>Major Stops</th><th>Time</th><th>Transport</th><th>Counter</th></tr>';
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    for (const route of (routes || [])){
      let count = 0;
      try {
        const r = await fetchWithCreds(`/route_count?date=${encodeURIComponent(iso)}&route_id=${route.id}`);
        const j = await r.json(); count = j.count || 0;
      } catch(e){ count = 0; }

      const transportText = route.transport_type || '';
      const tr = document.createElement('tr'); tr.dataset.routeId = route.id;
      tr.innerHTML = `<td>${route.slot_no}</td>
                      <td>${route.end_point || ''}</td>
                      <td>${route.major_stops || ''}</td>
                      <td>${route.time || '-'}</td>
                      <td>${transportText ? `<span class="transport-pill">${transportText}</span>` : ''}</td>
                      <td><span class="badge bg-info">${count}</span></td>`;
      tr.addEventListener('dblclick', async (ev) => {
        ev.preventDefault();
        await showCandidatesForRouteOnce(route.id, route);
      });
      tbody.appendChild(tr);
    }
    table.appendChild(tbody); wrapper.appendChild(table);
  }

  async function openRoutePanel(routeId){
    try {
      const r = await fetchWithCreds('/calendar/' + currentSelectedDate);
      const rows = await r.json();
      const route = rows.find(x=>x.id === routeId);
      if (!route){ alert('Route not found'); return; }
      el('candRouteLabel').textContent = `${route.slot_no} â†’ ${route.end_point || '-'}`;
      el('candidatesList').innerHTML = `<div class="p-2"><p><strong>Slot:</strong> ${route.slot_no}</p><p><strong>End Point:</strong> ${route.end_point || '-'}</p><p><strong>Major Stops:</strong> ${route.major_stops || '-'}</p><p><strong>Time:</strong> ${route.time || '-'}</p><p><strong>Transport:</strong> ${route.transport_type || '-'}</p><div class="mt-2 small-muted">Double-click the row in Route Details to view candidates (this will unlock Link Details).</div></div>`;
      el('candidatesMsg').textContent = '';
      const m = new bootstrap.Modal(document.getElementById('modalCandidates')); m.show();
    } catch(e){ console.error('openRoutePanel', e); alert('Unable to fetch route'); }
  }

  async function showCandidatesForRouteOnce(routeId, routeObj){
    if (lastCandidatesRouteId === routeId){ const m = new bootstrap.Modal(document.getElementById('modalCandidates')); m.show(); return; }
    try {
      el('candRouteLabel').textContent = `${routeObj.slot_no} â†’ ${routeObj.end_point || '-'}`;
      el('candidatesList').innerHTML = '<div class="text-muted small">Loading candidates...</div>';
      el('candidatesMsg').textContent = '';
      const resp = await fetchWithCreds(`/routes/${routeId}/links?date=${encodeURIComponent(currentSelectedDate)}`);
      if (!resp.ok){ el('candidatesList').innerHTML = '<div class="text-danger small">Unable to load candidates</div>'; }
      else {
        const people = await resp.json();
        if (!people || people.length === 0) el('candidatesList').innerHTML = '<div class="muted-small">No candidates joined this route yet.</div>';
        else {
          const ul = document.createElement('div'); ul.className = 'list-group';
          people.forEach(p => {
            const a = document.createElement('div'); a.className = 'list-group-item d-flex justify-content-between align-items-start';
            const left = document.createElement('div');
            left.innerHTML = `<div><strong>${escapeHtml(p.name)}</strong> <small class="text-muted">(${escapeHtml(p.course_year||'')} - ${escapeHtml(p.branch||'')})</small></div><div class="small-muted">${escapeHtml(p.drop_point||'')} â€¢ ${escapeHtml(p.phone||'')}</div>`;
            const right = document.createElement('div');
            const dmBtn = document.createElement('button'); dmBtn.className = 'btn btn-sm btn-primary dm-btn'; dmBtn.textContent = 'DM';
            dmBtn.addEventListener('click', ()=> ensureDmAndOpen(p.id, p.name));
            right.appendChild(dmBtn);
            a.appendChild(left); a.appendChild(right);
            ul.appendChild(a);
          });
          el('candidatesList').innerHTML = ''; el('candidatesList').appendChild(ul);
        }
      }
      enableLinks();
      lastCandidatesRouteId = routeId;
      viewingRouteId = routeId;
      const m = new bootstrap.Modal(document.getElementById('modalCandidates')); m.show();
    } catch(e){ console.error('showCandidates', e); el('candidatesList').innerHTML = '<div class="text-danger small">Network error</div>'; }
  }

  // --- Links: render table + DM column
  async function loadLinksForCurrentRoute(filterGender = 'All'){
    const rid = lastCandidatesRouteId;
    viewingRouteId = rid || viewingRouteId;
    if (!rid){
      try {
        const param = (filterGender && filterGender !== 'All') ? `?gender=${filterGender[0].toUpperCase()}` : '';
        const r = await fetchWithCreds('/links' + param);
        const list = await r.json();
        renderLinksTable(list);
      } catch(e){ console.error('loadAllLinks', e); }
      if (el('linksRouteLabel')) el('linksRouteLabel').textContent = `All Links`;
      return;
    }
    try {
      const r = await fetchWithCreds(`/routes/${rid}/links?date=${encodeURIComponent(currentSelectedDate)}`);
      let people = await r.json();
      if (filterGender && filterGender !== 'All') people = people.filter(p => (p.gender||'').toLowerCase() === filterGender[0].toLowerCase());
      renderLinksTable(people);
      if (el('linksRouteLabel')) el('linksRouteLabel').textContent = `Route ${rid} â€” ${currentSelectedDate}`;
    } catch(e){ console.error('loadLinksForCurrentRoute', e); }
  }

  function renderLinksTable(list){
    const tbody = el('linksTbody'); if (!tbody) return; tbody.innerHTML = '';
    if (!list || list.length === 0){ tbody.innerHTML = '<tr><td colspan="8" class="muted-small">No links</td></tr>'; return; }
    for (const p of list){
      const dmBtnHtml = `<button class="btn btn-sm btn-outline-success dm-btn" data-linkid="${escapeHtml(p.id)}" data-linkname="${escapeHtml(p.name||'')}">DM</button>`;
      let actionHtml = '<button class="btn btn-sm btn-outline-secondary" disabled>â€”</button>';
      if (loggedUser && loggedUser.name && p.name && loggedUser.name.trim().toLowerCase() === p.name.trim().toLowerCase()){
        actionHtml = `<button class="btn btn-sm btn-danger btn-delete" data-linkid="${p.id}" data-link-name="${p.name}">Delete</button>`;
      }
      const row = document.createElement('tr');
      row.innerHTML = `<td>${escapeHtml(p.name||'')}</td><td>${p.gender||''}</td><td>${escapeHtml(p.drop_point||'')}</td><td>${escapeHtml(p.phone||'')}</td><td>${escapeHtml(p.course_year||'')}</td><td>${escapeHtml(p.branch||'')}</td><td>${dmBtnHtml}</td><td>${actionHtml}</td>`;
      tbody.appendChild(row);
    }
    // attach DM click handlers
    tbody.querySelectorAll('.dm-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const id = btn.getAttribute('data-linkid');
        const name = btn.getAttribute('data-linkname') || 'Unknown';
        if (!id) return;
        // prevent messaging oneself: check if peer id equals logged user id or email (best-effort)
        if (loggedUser && (String(id) === String(loggedUser.id) || String(id) === String(loggedUser.email))){
          alert("You cannot message yourself.");
          return;
        }
        ensureDmAndOpen(id, name);
      });
    });
  }

  // Delete handler
  document.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('.btn-delete');
    if (!btn) return;
    const linkId = btn.getAttribute('data-linkid'), linkName = btn.getAttribute('data-link-name') || '';
    if (!linkId) return;
    if (!confirm(`Remove yourself (${linkName}) from this route?`)) return;
    try {
      const r = await fetchWithCreds(`/links/${linkId}`, { method:'DELETE' });
      if (r.ok){
        await loadLinksForCurrentRoute(el('linksGender')?.value || 'All');
        await loadRoutesForDate(currentSelectedDate);
      } else {
        const txt = await r.text(); alert('Delete failed: ' + txt);
      }
    } catch(e){ console.error('delete', e); alert('Network error while deleting'); }
  });

  // tab click handlers (open messages list when Messages tab clicked)
  document.addEventListener('click', (ev)=>{
    const t = ev.target;
    if (!t) return;
    if (t.id === 'tabBtnLinks' || t.closest('#tabBtnLinks')){
      if (el('tabBtnLinks').classList.contains('disabled')){ ev.preventDefault(); ev.stopPropagation(); return; }
      loadLinksForCurrentRoute(el('linksGender')?.value || 'All');
    }
    if (t.id === 'tabBtnRoutes' || t.closest('#tabBtnRoutes')){
      if (el('tabBtnRoutes').classList.contains('disabled')){ ev.preventDefault(); ev.stopPropagation(); return; }
      loadRoutesForDate(currentSelectedDate);
    }
    if (t.id === 'tabBtnCalendar' || t.closest('#tabBtnCalendar')){
      if (el('tabBtnCalendar').classList.contains('disabled')){ ev.preventDefault(); ev.stopPropagation(); return; }
    }
    if (t.id === 'tabBtnMessages' || t.closest('#tabBtnMessages')){
      if (el('tabBtnMessages').classList.contains('disabled')){ ev.preventDefault(); ev.stopPropagation(); return; }
      loadConversationsList();
    }
  }, true);

  // --- Startup: check /me
  (async function init(){
    try {
      await loadHolidays();
      await buildMiniCalendar();
      if (el('routesDateLabel')) el('routesDateLabel').textContent = currentSelectedDate;

      const meRes = await fetchWithCreds('/me');
      let meJson;
      try { meJson = await meRes.json(); } catch(e){ meJson = { id: null }; }
      if (meJson && meJson.id){
        loggedUser = { id: meJson.id, name: meJson.name, email: meJson.email || '' };
        el('userName').textContent = meJson.name || '';
        el('authArea').classList.add('hidden'); el('loggedBlock').classList.remove('hidden');
        enableCalendarOnly();
        enableMessages();
        new bootstrap.Tab(el('tabBtnCalendar')).show();
        loadRoutesForDate(currentSelectedDate);
        loadConversationsList();
      } else {
        disableAllTabsExceptHome();
        new bootstrap.Tab(el('tabBtnHome')).show();
      }
    } catch(e){ console.error('init', e); disableAllTabsExceptHome(); new bootstrap.Tab(el('tabBtnHome')).show(); }
  })();

  // ---------------- Messaging functions ----------------

  // load conversations list from server
  async function loadConversationsList(){
    const inner = el('convosInner'); if (!inner) return;
    inner.innerHTML = '<div class="small-muted">Loading conversations...</div>';
    try {
      const r = await fetchWithCreds('/conversations');
      if (!r.ok){ inner.innerHTML = '<div class="small-muted">No conversations available.</div>'; return; }
      const list = await r.json();
      conversationsCache = list || [];
      renderConversationsList();
    } catch(e){ console.error('load convos', e); inner.innerHTML = '<div class="small-muted">Unable to load conversations</div>'; }
  }

  function renderConversationsList(){
    const inner = el('convosInner'); if (!inner) return;
    inner.innerHTML = '';
    if (!conversationsCache || conversationsCache.length === 0){ inner.innerHTML = '<div class="small-muted">No conversations yet.</div>'; return; }
    conversationsCache.forEach(c => {
      const div = document.createElement('div'); div.className = 'convo-item';
      const avatar = document.createElement('div'); avatar.className = 'avatar'; avatar.textContent = c.avatar_emoji || (c.type === 'group' ? 'ðŸ‘¥' : 'ðŸ™‚');
      const meta = document.createElement('div'); meta.style.flex = '1';
      meta.innerHTML = `<div><strong>${escapeHtml(c.name || 'Unknown')}</strong></div><div class="small-muted">${escapeHtml(c.last_message || '')}</div>`;
      div.appendChild(avatar); div.appendChild(meta);
      div.addEventListener('click', ()=> openConversation(c.id, c.name, c.type));
      inner.appendChild(div);
    });
  }

  // Open a conversation (if DM, ensure it exists server-side)
  async function openConversation(id, name, type = 'dm'){
    try {
      if (type === 'dm'){
        // prevent opening DM with yourself (best effort)
        if (loggedUser && (String(id) === String(loggedUser.id) || String(id) === String(loggedUser.email))){
          alert("You cannot message yourself.");
          return;
        }
        // ensure DM exists server-side and get conversation id
        const res = await fetchWithCreds(`/conversations/${encodeURIComponent(id)}/ensure`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
        if (res.ok){
          const payload = await res.json();
          activeConversation = { type: 'dm', id: payload.convo_id || payload.id || id, name: payload.name || name };
        } else {
          // fallback: use provided id but still open
          activeConversation = { type: 'dm', id, name };
        }
      } else {
        // group
        activeConversation = { type: 'group', id, name };
      }

      // switch to Messages tab
      enableMessages();
      new bootstrap.Tab(el('tabBtnMessages')).show();

      el('activeConvoAvatar').textContent = (activeConversation.type === 'group' ? 'ðŸ‘¥' : 'ðŸ™‚');
      el('activeConvoName').innerHTML = `<strong>${escapeHtml(activeConversation.name || 'Conversation')}</strong>`;
      el('activeConvoSub').textContent = activeConversation.type === 'group' ? 'Group chat' : 'Direct message';

      await loadMessagesForActiveConversation();
      setTimeout(()=> el('msgText')?.focus(), 200);

      if (convoPollTimer) clearInterval(convoPollTimer);
      convoPollTimer = setInterval(()=> {
        loadMessagesForActiveConversation(true).catch(()=>{});
        loadConversationsList().catch(()=>{});
      }, 3500);

    } catch(e){ console.error('openConversation', e); alert('Error opening conversation'); }
  }

  // load messages for the active conversation
  async function loadMessagesForActiveConversation(silent=false){
    const listNode = el('msgList'); if (!listNode) return;
    if (!activeConversation){ if (!silent) listNode.innerHTML = '<div class="small-muted">No conversation selected</div>'; return; }
    listNode.innerHTML = '<div class="small-muted">Loading messages...</div>';
    try {
      let url = activeConversation.type === 'group' ? `/conversations/group/${encodeURIComponent(activeConversation.id)}` : `/conversations/${encodeURIComponent(activeConversation.id)}`;
      const r = await fetchWithCreds(url);
      if (!r.ok){ listNode.innerHTML = '<div class="small-muted">No messages yet.</div>'; return; }
      const messages = await r.json();
      if (!messages || messages.length === 0){ listNode.innerHTML = '<div class="small-muted">No messages yet.</div>'; return; }
      listNode.innerHTML = '';
      for (const m of messages){
        const isMe = loggedUser && (String(m.from_id) === String(loggedUser.id) || String(m.from_id) === String(loggedUser.email));
        const row = document.createElement('div'); row.className = 'msg-row' + (isMe ? ' me' : '');
        const avatar = document.createElement('div'); avatar.className = 'avatar'; avatar.textContent = m.from_avatar || (isMe ? 'ðŸ§‘' : 'ðŸ™‚');
        const bubble = document.createElement('div'); bubble.className = 'msg-bubble' + (isMe ? ' me' : ''); bubble.innerHTML = `<div style="font-size:0.95rem">${escapeHtml(m.text)}</div><div class="small-muted" style="font-size:0.75rem;margin-top:6px">${escapeHtml(m.from_name || '')} â€¢ ${new Date(m.ts || Date.now()).toLocaleString()}</div>`;
        row.appendChild(avatar); row.appendChild(bubble);
        listNode.appendChild(row);
      }
      listNode.scrollTop = listNode.scrollHeight + 200;
    } catch(e){ console.error('load messages', e); if (!silent) listNode.innerHTML = '<div class="small-muted">Unable to load messages</div>'; }
  }

  // send message from input to active conversation
  async function sendMessageFromInput(){
    const input = el('msgText'); if (!input) return;
    const text = (input.value || '').trim();
    if (!text) return;
    if (!activeConversation){ alert('Select a conversation first'); return; }
    // prevent sending to self in DM mode (extra protection)
    if (activeConversation.type === 'dm' && loggedUser && (String(activeConversation.id) === String(loggedUser.id) || String(activeConversation.id) === String(loggedUser.email))){
      alert("You cannot message yourself.");
      return;
    }
    try {
      let url = activeConversation.type === 'group' ? `/conversations/group/${encodeURIComponent(activeConversation.id)}/send` : `/conversations/${encodeURIComponent(activeConversation.id)}/send`;
      // optimistic local append: show message immediately
      const optimistic = {
        from_id: loggedUser && loggedUser.id ? loggedUser.id : 'me',
        from_name: loggedUser && loggedUser.name ? loggedUser.name : 'Me',
        from_avatar: 'ðŸ§‘',
        text: text,
        ts: Date.now()
      };
      // append optimistic to UI
      const listNode = el('msgList'); if (listNode){
        const row = document.createElement('div'); row.className = 'msg-row me';
        const avatar = document.createElement('div'); avatar.className = 'avatar'; avatar.textContent = optimistic.from_avatar;
        const bubble = document.createElement('div'); bubble.className = 'msg-bubble me'; bubble.innerHTML = `<div style="font-size:0.95rem">${escapeHtml(optimistic.text)}</div><div class="small-muted" style="font-size:0.75rem;margin-top:6px">${escapeHtml(optimistic.from_name)} â€¢ ${new Date(optimistic.ts).toLocaleString()}</div>`;
        row.appendChild(avatar); row.appendChild(bubble);
        listNode.appendChild(row);
        listNode.scrollTop = listNode.scrollHeight + 200;
      }

      const r = await fetchWithCreds(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text }) });
      if (!r.ok){
        const txt = await r.text().catch(()=>r.statusText);
        alert('Send failed: ' + txt);
        // on failure, reload messages from server to reconcile
        await loadMessagesForActiveConversation();
        return;
      }
      input.value = '';
      await loadMessagesForActiveConversation();
      await loadConversationsList();
    } catch(e){ console.error('send', e); alert('Network error while sending'); }
  }

  // ensure DM exists and open it
  async function ensureDmAndOpen(peerId, peerName){
    try {
      // prevent messaging self (if peerId equals loggedUser.id or email)
      if (loggedUser && (String(peerId) === String(loggedUser.id) || String(peerId) === String(loggedUser.email))){
        alert("You cannot message yourself.");
        return;
      }
      const res = await fetchWithCreds(`/conversations/${encodeURIComponent(peerId)}/ensure`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: peerName }) });
      if (res.ok){
        const j = await res.json();
        openConversation(j.convo_id || j.id || peerId, j.name || peerName, 'dm');
      } else {
        // fallback to opening direct id
        openConversation(peerId, peerName, 'dm');
      }
    } catch(e){ console.error('ensure dm', e); openConversation(peerId, peerName, 'dm'); }
  }

  </script>
</body>
</html>
